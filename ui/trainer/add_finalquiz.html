<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
        <!-- <link rel="stylesheet" href="../../static/uploadCM.css"> -->

        <!-- Start of Tab Icon -->
        <title> All-in-One LMS </title>
        <link rel="icon" href="../../static/imgs/All-In-One 1.png" type="image/icon type">
        <!-- End of Tab Icon -->

        <!-- Icons -->
        <script src="https://unpkg.com/feather-icons"></script>

        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

        <!-- common js functions -->
        <script src="../js/common.js"></script>

        <style>
            body{
                font-family: 'Montserrat', sans-serif;
            }
            
            label {
                display: inline;
            }

            .addbutton{
                background-color: #566E92;
                border: none;
                color: white;
                padding: 3px 5px;
                text-align: center;
                font-size: 16px;
                cursor: pointer;
                margin: 120px 130px;
            }

            .nav {
                padding-top: 20px;
            }

            input[type=button], button {
                background: #FF922D ;
                color: white ; 
                border: none ;
                border-radius: 3px ; 
                padding: 5px ;
                width: 120px ;
            }

            .icon {
                color: #FF922D ;
                padding: 2px ;
            }

            #loadingModal, #loading {
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                text-align: center;
                background-color: #fff;
            }

            #loading-image {
                margin-top: 50px;
            }
        </style>
    </head>
    <body>

        <div class='container'>

            <div class="row">
                <div class="col">
                    <!-- Start of Main Page Icon  -->
                    <div class="col-xs-12 col-s-12 col-md-1 mx-0  ">
                        <img id="logo" src="../../static/imgs/All-In-One 1.png" width="270px" height="125px" onclick="trainerHome()" style='cursor:pointer;'>
                    </div>
                    <!-- End of Main Page Icon  -->
                    <h4 id="courseName"><u>Engineering Basics 101</u></h4>                    
                    <h5 id="groupName">Group 3 </h5>
                </div>
        
                <div class="col-2">
                    <!-- Start of NavBar -->
                    <nav class="nav float-right" id="topnavbar">
                        <input type="button" value="Log Out" id="logout" onclick='logout()'>
                    </nav>

                </div>
            </div>

            <hr>
            <h6 id="MaterialName"><u>Add Quiz (Graded)</u></h6>
            <br>
        
            <div class='row'>
                <div class='col'>
                    <label for="DR" id="DR"> Duration (in minutes) </label>                
                    <input type="number" id="duration" placeholder="Please enter the duration" style='width: 250px'/>

                    <br><br>

                    <div id="" class="two">
                        <button onclick="four_Question()">+ MCQ</button>
                        <button onclick="TFQuestion()">+ TrueFalse</button>
                    </div>
                </div> 
            </div>

            <div class='row'>
                <div class="three">
                    <br>
                    <h5>Added Questions</h5> <br>
                    <form action="" id="form" method="POST" name="form">
                        <span id="myForm"></span>
                        <div class="row" style="padding-top: 43px ; padding-left: 15px" >
                            <input type="button" value="Submit" onclick="add_Quiz()"> 
                        </div>
                        <div class="row" style="padding-top: 43px ; padding-left: 15px" >
                            <input type="button" value="Reset" onclick="resetElements()"> 
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Success modal -->
        <div id="successModal" class="modal fade">
            <div class="modal-dialog modal-confirm">
                <div class="modal-content">
                    <div class="modal-header flex-column">
                        <div class="icon">
                            <i data-feather="check-circle"></i>
                        </div>						
                        <h4 class="modal-title w-100">Success!</h4>	
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p id='successMessage'></p>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button id='successBtn' type="button" class="btn btn-secondary" data-dismiss="modal" onclick="window.location='./section_management.html'">Okay</button>
                    </div>
                </div>
            </div>
        </div> 

        <!-- failure modal -->
        <div id="failureModal" class="modal fade">
            <div class="modal-dialog modal-confirm">
                <div class="modal-content">
                    <div class="modal-header flex-column">
                        <div class="icon">
                            <i data-feather="alert-triangle"></i>
                        </div>						
                        <h4 class="modal-title w-100">Error!</h4>	
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p id='failureMessage'></p>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Okay</button>
                    </div>
                </div>
            </div>
        </div> 

        <!-- loading modal -->
        <div id="loadingModal" class="modal fade">
            <div class="modal-dialog modal-confirm">
                <div class="modal-content">
                    <div class="modal-header flex-column">				
                        <h4 class="modal-title w-100">Loading.....</h4>	
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="modalloading">
                            <img id="loading-image" src="../../static/imgs/loading.gif" alt="Loading..." />
                        </div>  
                    </div>
                </div>
            </div>
        </div> 

    </body>
</html>

<script>

    const api_endpoint = "http://52.55.242.44:8000/"
    // const api_endpoint = "http://localhost:8000/"

    let query = window.location.search.substring(1).split("&");
    const group_id = query[0].slice(8,);
    const course_name = sessionStorage.getItem('course_name');

    $(async () => {
        $("#courseName").text(`${course_name} `);
        $("#groupName").text(`Group ${group_id}`);
        $("#successBtn").attr('onclick', `window.location='${sessionStorage.getItem('url')}'`)
        sessionStorage.removeItem('url')
    })

    async function add_Quiz() {
        if (!document.getElementById('myForm').innerHTML) {            
            $("#failureMessage").text(`There are not questions added yet!`)
            $("#failureModal").modal("show");
        } else {
            $('#loadingModal').modal("show");
            data = []
            for (let count = 1; count<=i; count++ ){
                if ($("#TF1_" + count).val()) {
                    data.push({
                        group_id: group_id,
                        question_no: count,
                        question: $(`#QN_in${count}`).val(),
                        duration: $("#duration").val() * 60,
                        choice: [$("#TF1_" + count).val(), $("#TF2_" + count).val()],
                        answer: $('#ans' + count).val() 
                    })
                }
                else {
                    data.push({
                        group_id: group_id,
                        question_no: count,
                        question: $(`#QN_in${count}`).val(),
                        duration: $("#duration").val() * 60,
                        choice: [$("#FQ1_" + count).val(), $("#FQ2_" + count).val(), $("#FQ3_" + count).val(), $("#FQ4_" + count).val()],
                        answer: $('#ans' + count).val() 
                    })
                }
            }
            const create_course_api = api_endpoint + "group_quiz"
            try {
                const response = await fetch(
                    create_course_api, {
                        method: 'POST',
                        headers: {"Content-Type":"application/json"},
                        body: JSON.stringify(data)
                    }
                );

                const result = await response.json();
                console.log(result)
                $("#loadingModal").modal("hide");
                if (response.status === 200) {
                    $("#successMessage").text(result.message)
                    $("#successModal").modal("show");
                } else { 
                    $("#failureMessage").text(result.message)
                    $("#failureModal").modal("show");
                }
            } catch (err) {
                $("#failureMessage").text(result.message)
                $("#failureModal").modal("show");
                console.log(err)
            }
        }
    }
    

    var i = 0; /* Set Global Variable i */
    function increment(){
        i += 1; /* Function for automatic increment of field's "Name" attribute. */
    }

    // Function to remove question
    function removeElement(parentDiv, childDiv){
        if (childDiv == parentDiv){
            alert("The parent div cannot be removed.");
        } else if (document.getElementById(childDiv)){
            var child = document.getElementById(childDiv);
            var parent = document.getElementById(parentDiv);
            parent.removeChild(child);

            let q_no = +childDiv.substring(1);
            for (let q = q_no; q < i; q++) {
                document.getElementById(`Q${q+1}`).setAttribute('id', `Q${q}`);            
                document.getElementById(`ans${q+1}`).setAttribute("id", `ans${q}`);
                document.getElementById(`del${q+1}`).setAttribute("onclick", `removeElement('myForm','Q${q}')`);            
                document.getElementById(`del${q+1}`).setAttribute("id", `del${q}`);
            }
            i--;
        } else{
            alert("Child div has already been removed or does not exist.");
            return false;
        }
    }

    // Add a new TF Question
    function TFQuestion(){

        increment();
        
        var QN = document.createElement('span');
        var QN_in = document.createElement("INPUT");
        var first = document.createElement('span');
        var first_in = document.createElement("INPUT");
        var second = document.createElement('span');
        var second_in = document.createElement("INPUT");
        var answer = document.createElement('span');
        var answer_in = document.createElement('INPUT');

        QN_in.setAttribute("type", "text");
        QN_in.setAttribute("placeholder", "TFQuestion");
        first_in.setAttribute("type", "text");
        first_in.setAttribute("placeholder", "FirstQn");
        second_in.setAttribute("type", "text");
        second_in.setAttribute("placeholder", "SecondQn");
        answer_in.setAttribute("type", "text")
        answer_in.setAttribute("placeholder", "Answer")

        var icon = document.createElement("i");        
        icon.setAttribute("data-feather", "trash-2")
        var g = document.createElement("a");
        g.setAttribute("id","del" + i)
        g.setAttribute("class","icon")
        g.appendChild(icon)

        var q_div = document.createElement('div')     
        q_div.setAttribute("id", "Q" + i);
        q_div.setAttribute("style", "padding-bottom: 20px");
        document.getElementById("myForm").appendChild(q_div);

        QN_in.setAttribute("id", "QN_in" + i);
        QN.appendChild(QN_in);
        QN.setAttribute("id", "id_" + i);
        document.getElementById("Q" + i).appendChild(QN);

        first_in.setAttribute("id", "TF1_" + i);
        first.appendChild(first_in);
        first.setAttribute("id", "id_" + i);
        document.getElementById("Q" + i).appendChild(first);

        second_in.setAttribute("id", "TF2_" + i);
        second.appendChild(second_in);
        second.setAttribute("id", "id_" + i);
        document.getElementById("Q" + i).appendChild(second);

        answer_in.setAttribute("id", "ans" + i);
        answer.appendChild(answer_in);
        answer.setAttribute("id", "id_" + i);
        answer.appendChild(g);
        g.setAttribute("onclick", "removeElement('myForm','Q" + i + "')");
        document.getElementById("Q" + i).appendChild(answer)

        feather.replace()
    }

    // Add new MCQ Question
    function four_Question(){
            
        increment();

        var QN = document.createElement('span');
        var QN_in = document.createElement("INPUT");
        var first = document.createElement('span');
        var first_in = document.createElement("INPUT");
        var second = document.createElement('span');
        var second_in = document.createElement("INPUT");
        var third = document.createElement('span');
        var third_in = document.createElement("INPUT");
        var fourth = document.createElement('span');
        var fourth_in = document.createElement("INPUT");
        var answer = document.createElement('span');
        var answer_in = document.createElement('INPUT');

        QN_in.setAttribute("type", "text");
        QN_in.setAttribute("placeholder", "FourQuestion");
        first_in.setAttribute("type", "text");
        first_in.setAttribute("placeholder", "FirstQn");
        second_in.setAttribute("type", "text");
        second_in.setAttribute("placeholder", "SecondQn");
        third_in.setAttribute("type", "text");
        third_in.setAttribute("placeholder", "ThirdQn");
        fourth_in.setAttribute("type", "text");
        fourth_in.setAttribute("placeholder", "FourthQn");
        answer_in.setAttribute("type", "text")
        answer_in.setAttribute("placeholder", "Answer")

        var icon = document.createElement("i");        
        icon.setAttribute("data-feather", "trash-2")
        var g = document.createElement("a");
        g.setAttribute("id","del" + i)
        g.setAttribute("class","icon")
        g.appendChild(icon)

        var q_div = document.createElement('div')     
        q_div.setAttribute("id", "Q" + i);
        q_div.setAttribute("style", "padding-bottom: 20px");
        document.getElementById("myForm").appendChild(q_div);


        QN_in.setAttribute("id", "QN_in" + i);
        QN.appendChild(QN_in);
        QN.setAttribute("id", "id_" + i);
        document.getElementById("Q" + i).appendChild(QN);

        first_in.setAttribute("id", "FQ1_" + i);
        first.appendChild(first_in);
        first.setAttribute("id", "id_" + i);
        document.getElementById("Q" + i).appendChild(first);

        second_in.setAttribute("id", "FQ2_" + i);
        second.appendChild(second_in);
        second.setAttribute("id", "id_" + i);
        document.getElementById( "Q" + i).appendChild(second);

        third_in.setAttribute("id", "FQ3_" + i);
        third.appendChild(third_in);
        third.setAttribute("id", "id_" + i);
        document.getElementById("Q" + i).appendChild(third);

        fourth_in.setAttribute("id", "FQ4_" + i);
        fourth.appendChild(fourth_in);
        fourth.setAttribute("id", "id_" + i);
        document.getElementById("Q" + i).appendChild(fourth);

        answer_in.setAttribute("id", "ans" + i);
        answer.appendChild(answer_in);
        answer.setAttribute("id", "id_" + i);
        g.setAttribute("onclick", "removeElement('myForm','Q" + i + "')");
        answer.appendChild(g);
        document.getElementById("Q" + i).appendChild(answer);
        
        feather.replace()
    }      

    // Clear everything from page
    function resetElements(){
        document.getElementById('myForm').innerHTML = '';
    }

</script>